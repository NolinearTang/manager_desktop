<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品标签体系 - 实体标签体系详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Choices.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#36D399',
                        warning: '#FBBD23',
                        error: '#F87272',
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
            .tag-active { 
                background-color: rgba(22, 93, 255, 0.1); 
                border-left: 3px solid #165DFF; 
                font-weight: 500; 
            }
            .tree-line { position: relative; }
            .tree-line::before {
                content: "";
                position: absolute;
                left: -12px; top: 0;
                height: 100%; width: 1px;
                background-color: #D1D5DB;
            }
            .tree-line::after {
                content: "";
                position: absolute;
                left: -12px; top: 10px;
                width: 6px; height: 1px;
                background-color: #D1D5DB;
            }
            /* 层级样式 */
            .level-1 { font-weight: 600; }
            .level-2 { padding-left: 0.75rem; }
            .level-3 { padding-left: 1.5rem; }
            .level-4 { padding-left: 2.25rem; }
            .level-5 { padding-left: 3rem; }
            .empty-value { color: #9CA3AF; font-style: italic; }
            .tag-item:hover .opacity-0 { opacity: 1 !important; }
            .tag-item { white-space: nowrap; }
            .tag-item span { overflow: hidden; text-overflow: ellipsis; }

            /* Custom styles for Choices.js to match Tailwind inputs */
            .choices__inner {
                background-color: #fff;
                border: 1px solid #D1D5DB; /* approx. border-neutral-300 */
                border-radius: 0.5rem;      /* rounded-lg */
                font-size: 0.875rem;        /* text-sm */
                min-height: auto;
                padding: 0.4rem 0.75rem;    /* similar to py-2 px-3 */
                line-height: 1.25rem;
            }

            .is-focused .choices__inner {
                border-color: #165DFF;      /* border-primary */
                box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.3); /* focus:ring-2 focus:ring-primary/30 */
            }

            .choices__list--multiple .choices__item {
                background-color: rgba(22, 93, 255, 0.1); /* primary/10 */
                border: 1px solid transparent;
                border-radius: 0.25rem;   /* rounded */
                font-size: 0.875rem;       /* text-sm */
            }

            .choices__placeholder {
                color: #9CA3AF;            /* text-neutral-400 */
                font-size: 0.875rem;        /* text-sm */
                opacity: 1;
            }

            /* Dropdown items: smaller font and no-wrap */
            .choices__list--dropdown .choices__item {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 0.75rem; /* text-xs */
            }

            /* Synonyms (text input) specific styles */
            .choices[data-type*="text"] .choices__inner {
                min-height: 5rem; /* Taller input box */
                padding-top: 0.5rem;
            }

            .choices[data-type*="text"] .choices__input {
                width: 100%; /* Fix for input being too narrow */
                margin-bottom: 0.25rem;
                display: block; /* Ensure it takes full width */
            }

            /* Compact style for single-select Choices.js */
            .choices[data-type*="select-one"] .choices__inner {
                padding-top: 0.2rem;
                padding-bottom: 0.2rem;
                min-height: auto;
            }
        }
    </style>
</head>
<body class="font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-neutral-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- 系统标识 -->
                <div class="flex items-center">
                    <i class="fa fa-cogs text-primary text-2xl mr-2"></i>
                    <span class="text-xl font-semibold text-neutral-800">实体标签体系</span>
                </div>
                
                <!-- 功能导航 -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="javascript:history.back()" class="text-neutral-600 hover:text-primary py-5 transition-colors">标签体系列表</a>
                    <a href="#" class="text-primary font-medium border-b-2 border-primary py-5">实体标签管理</a>
                    <a href="#" class="text-neutral-600 hover:text-primary py-5 transition-colors">系统设置</a>
                </nav>
                
                <!-- 用户信息 -->
                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full text-neutral-600 hover:bg-neutral-100 transition-colors">
                        <i class="fa fa-bell-o"></i>
                    </button>
                    <div class="flex items-center">
                        <img src="https://picsum.photos/id/1005/200/200" alt="用户头像" class="h-8 w-8 rounded-full object-cover">
                        <span class="ml-2 text-sm font-medium hidden sm:block">管理员</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 面包屑导航 -->
    <div class="bg-white border-b border-neutral-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="javascript:history.back()" class="text-neutral-500 hover:text-primary transition-colors">标签体系列表</a>
                <i class="fa fa-chevron-right text-neutral-400 text-xs"></i>
                <span class="text-neutral-800 font-medium">产品标签体系</span>
            </nav>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- 左侧 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg card-shadow h-full flex flex-col">
                    <div class="p-4 border-b border-neutral-200">
                        <h2 class="text-lg font-semibold text-neutral-800">产品标签体系</h2>
                        <p class="text-xs text-neutral-500 mt-1">产品标签体系 - 标准化层级：产品类别>产品线>产品系列>产品型号>产品规格</p>
                    </div>
                    <div id="tag-tree-container" class="p-2 overflow-y-auto flex-grow text-sm">
                        <!-- 标签树将由JS动态生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 右侧 -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg card-shadow h-full flex flex-col">
                    <div class="p-4 border-b border-neutral-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 class="text-lg font-semibold text-neutral-800">实体信息列表</h2>
                            <p class="text-sm text-neutral-500 mt-1" id="current-tag-desc">请在左侧选择标签，查看对应实体信息</p>
                        </div>
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="relative w-full sm:w-64">
                                <input type="text" placeholder="搜索实体..." class="w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none text-sm">
                                <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
                            </div>
                            <button id="add-entity-button" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                                <i class="fa fa-plus mr-2"></i>
                                <span class="hidden sm:inline">新增实体</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto">
                        <div id="default-empty" class="flex flex-col items-center justify-center h-64 text-neutral-500">
                            <i class="fa fa-folder-open-o text-4xl mb-4"></i>
                            <p>未选择标签</p>
                            <p class="text-sm mt-2">请在左侧点击标签，加载对应实体数据</p>
                        </div>
                        
                        <div id="entity-list" class="hidden">
                            <table class="min-w-full divide-y divide-neutral-200">
                                <thead class="bg-neutral-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">实体名称</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">编码</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">父级标签</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">同义词</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">状态</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-neutral-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-neutral-200" id="entity-items">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 新增实体弹窗 -->
    <div id="add-entity-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-neutral-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-neutral-800">新增实体</h3>
                    <button onclick="closeAddEntityModal()" class="text-neutral-400 hover:text-neutral-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 flex-grow overflow-y-hidden flex flex-col">
                <form id="add-entity-form" class="flex flex-col flex-grow space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-2">所属标签</label>
                        <input type="text" id="entity-parent-tag" readonly class="w-full px-3 py-2 border border-neutral-300 rounded-lg bg-neutral-50 text-neutral-600">
                    </div>

                    <!-- 表头 -->
                    <div class="grid grid-cols-12 gap-4 px-2 pb-2 border-b border-neutral-200 text-sm font-medium text-neutral-600">
                        <div class="col-span-2">父级标签</div>
                        <div class="col-span-3">实体名称</div>
                        <div class="col-span-4">同义词</div>
                        <div class="col-span-1 flex items-center justify-center">
                             <input type="checkbox" id="master-status-switch" class="h-4 w-4 rounded text-primary focus:ring-primary mr-1" title="全部启用/禁用">
                             <label for="master-status-switch">启用</label>
                        </div>
                        <div class="col-span-2 text-center">操作</div>
                    </div>
                    <!-- 可滚动的实体行容器 -->
                    <div id="entity-rows-container" class="space-y-1 flex-grow overflow-y-auto pr-2 h-72 py-2"></div>

                    <div>
                        <button type="button" onclick="addEntityRow()" class="w-full text-sm text-primary border-2 border-dashed border-primary/50 rounded-lg py-2 hover:bg-primary/5 transition-colors">
                            <i class="fa fa-plus mr-2"></i>添加另一个实体
                        </button>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-neutral-200 bg-neutral-50 rounded-b-lg">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddEntityModal()" class="px-4 py-2 text-neutral-600 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" form="add-entity-form" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        确定新增
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增标签弹窗 -->
    <div id="add-tag-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <form id="add-tag-form">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">新增标签</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="label-name" class="block text-sm font-medium text-neutral-700 mb-1">标签名称 (必填)</label>
                        <input type="text" id="label-name" name="label_name" required class="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label for="label-code" class="block text-sm font-medium text-neutral-700 mb-1">标签编码 (必填, 英文/数字)</label>
                        <input type="text" id="label-code" name="label_code" required class="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label for="parent-label-code" class="block text-sm font-medium text-neutral-700 mb-1">父级标签 (可选)</label>
                        <select id="parent-label-code" name="parent_label_code" class="w-full"></select>
                    </div>
                    <div>
                        <label for="label-description" class="block text-sm font-medium text-neutral-700 mb-1">描述 (可选)</label>
                        <textarea id="label-description" name="description" rows="2" class="w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm"></textarea>
                    </div>
                </div>
                <div class="p-4 bg-neutral-50 rounded-b-lg flex justify-end space-x-3">
                    <button type="button" id="cancel-add-tag" class="px-4 py-2 text-neutral-600 border border-neutral-300 rounded-lg hover:bg-neutral-100">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">确定新增</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Choices.js JS, moved to the bottom -->    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <!-- API and App Logic -->
    <script src="js/api.js"></script>
    <!-- Main Application JavaScript -->
    <script>
        let currentLabelCode = null;
        let currentTagName = null;

        // --- Renders the tag tree from data ---
        function renderTagTree(nodes, container) {
            const ul = document.createElement('ul');
            ul.className = 'space-y-1';

            nodes.forEach(node => {
                const li = document.createElement('li');
                li.className = `level-${node.level}`;
                if (node.level > 1) {
                    li.classList.add('tree-line');
                }

                const hasChildren = node.children && node.children.length > 0;
                const iconClass = hasChildren ? 'fa-folder-open-o' : 'fa-folder-o';

                li.innerHTML = `
                    <div class="tag-item group pl-2 pr-1 py-1 rounded hover:bg-neutral-100 cursor-pointer flex items-center justify-between" data-label-id="${node.id}" data-label-code="${node.label_code}" data-label-name="${node.label_name}">
                        <div class="flex items-center overflow-hidden">
                            <i class="toggle-icon fa ${iconClass} text-primary mr-2"></i>
                            <span class="truncate">${node.label_name}</span>
                        </div>
                        <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="add-sub-tag-button p-1 text-green-600 hover:bg-green-100 rounded" title="新增子标签" data-parent-code="${node.label_code}">
                                <i class="fa fa-plus text-xs"></i>
                            </button>
                            <button class="delete-tag-button p-1 text-red-600 hover:bg-red-100 rounded" title="删除标签" data-label-id="${node.id}" data-label-name="${node.label_name}">
                                <i class="fa fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;

                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'pl-4 mt-1';
                    renderTagTree(node.children, childrenContainer);
                    li.appendChild(childrenContainer);
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        // --- Data Loading for Entities ---
        async function loadEntityData(labelCode) {
            const entityItems = document.getElementById('entity-items');
            entityItems.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-neutral-500"><i class="fa fa-spinner fa-spin mr-2"></i>正在加载数据...</td></tr>`;
            document.getElementById('default-empty').classList.add('hidden');
            document.getElementById('entity-list').classList.remove('hidden');
            
            try {
                const response = await window.api.getItemsForLabel(labelCode);
                const items = response.data || [];
                entityItems.innerHTML = '';
                if (items.length === 0) {
                    entityItems.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-neutral-500"><i class="fa fa-inbox fa-lg mb-2"></i><p>该标签下暂无实体数据</p></td></tr>`;
                    return;
                }
                items.forEach(item => {
                    const status = item.is_active ? '启用' : '禁用';
                    const statusClass = item.is_active ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const synonymsDisplay = item.item_synonym ? item.item_synonym : '<span class="empty-value">无</span>';
                    const parentTagDisplay = '<span class="empty-value">N/A</span>';

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-neutral-50 transition-colors';
                    row.innerHTML = `
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral-900">${item.item_name}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">${item.item_code || '<span class="empty-value">无</span>'}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-700">${parentTagDisplay}</td>
                      <td class="px-6 py-4 text-sm text-neutral-500">${synonymsDisplay}</td>
                      <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span></td>
                      <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-3">
                          <button class="text-primary hover:text-primary/80">编辑</button>
                          <button class="text-error hover:text-error/80 delete-button" data-item-id="${item.id}">删除</button>
                        </div>
                      </td>
                    `;
                    entityItems.appendChild(row);
                });
            } catch (error) {
                console.error("Failed to load entity data:", error);
                entityItems.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-red-500"><i class="fa fa-exclamation-triangle mb-2"></i><p>数据加载失败</p><p class="text-xs mt-1">${error.message}</p></td></tr>`;
            }
        }

        // --- Modal Helpers (for Add Entity) ---
        function openAddEntityModal() {
            if (!currentLabelCode) {
                alert('请先在左侧选择一个标签！');
                return;
            }
            document.getElementById('entity-parent-tag').value = `当前所属标签: ${currentTagName}`;
            document.getElementById('entity-rows-container').innerHTML = '';
            addEntityRow();
            document.getElementById('add-entity-modal').classList.remove('hidden');
        }

        function closeAddEntityModal() {
            document.getElementById('add-entity-modal').classList.add('hidden');
            document.getElementById('entity-rows-container').innerHTML = '';
        }

        function addEntityRow() {
            const container = document.getElementById('entity-rows-container');
            const newRow = document.createElement('div');
            newRow.className = 'entity-row grid grid-cols-12 gap-4 items-center px-2 py-2';
            newRow.innerHTML = `
                <div class="col-span-3">
                    <input type="text" placeholder="实体名称 (必填)" class="item-name-input w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm">
                </div>
                <div class="col-span-3">
                    <input type="text" placeholder="实体编码 (可选)" class="item-code-input w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm">
                </div>
                <div class="col-span-3">
                    <input type="text" placeholder="同义词,逗号隔开" class="item-synonym-input w-full px-3 py-2 border border-neutral-300 rounded-lg text-sm">
                </div>
                <div class="col-span-1 flex justify-center">
                    <input type="checkbox" class="entity-status-switch h-4 w-4 rounded text-primary focus:ring-primary" checked>
                </div>
                <div class="col-span-1 flex justify-center">
                    <button type="button" onclick="this.closest('.entity-row').remove()" class="text-neutral-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-neutral-100 transition-colors text-xl font-bold">&times;</button>
                </div>
            `;
            container.appendChild(newRow);
        }

        // --- Main App Initialization ---
        async function initializeApp() {
            const treeContainer = document.getElementById('tag-tree-container');
            treeContainer.innerHTML = '<p class="p-4 text-neutral-500">正在加载标签树...</p>';

            try {
                const response = await window.api.getLabelTree({ label_type: 'entity' });
                treeContainer.innerHTML = ''; // Clear loading message
                renderTagTree(response.data, treeContainer);
            } catch (error) {
                console.error("Failed to load tag tree:", error);
                treeContainer.innerHTML = '<p class="p-4 text-red-500">标签树加载失败</p>';
            }

            // --- Event Delegation for Dynamic Content ---
            treeContainer.addEventListener('click', async function(e) {
                const toggleIcon = e.target.closest('.toggle-icon');
                const addButton = e.target.closest('.add-sub-tag-button');
                const deleteButton = e.target.closest('.delete-tag-button');
                const tagItem = e.target.closest('.tag-item');

                e.stopPropagation();

                if (toggleIcon) {
                    const subTree = toggleIcon.closest('li').querySelector('ul');
                    if (subTree) {
                        subTree.classList.toggle('hidden');
                        toggleIcon.classList.toggle('fa-folder-o');
                        toggleIcon.classList.toggle('fa-folder-open-o');
                    }
                    return;
                }

                if (addButton) {
                    const parentCode = addButton.dataset.parentCode;
                    openAddTagModal(parentCode);
                    return;
                }

                if (deleteButton) {
                    const labelId = deleteButton.dataset.labelId;
                    const labelName = deleteButton.dataset.labelName;
                    deleteTag(labelId, labelName);
                    return;
                }

                if (tagItem) {
                    treeContainer.querySelectorAll('.tag-item').forEach(tag => tag.classList.remove('tag-active'));
                    tagItem.classList.add('tag-active');
                    currentLabelCode = tagItem.dataset.labelCode;
                    currentTagName = tagItem.dataset.labelName;
                    document.getElementById('current-tag-desc').textContent = `当前标签: ${currentTagName} - 实体信息列表`;
                    if (currentLabelCode) {
                        await loadEntityData(currentLabelCode);
                    }
                }
            });

            // --- Static Event Listeners ---
            document.getElementById('entity-items').addEventListener('click', async function(e) {
                if (e.target && e.target.classList.contains('delete-button')) {
                    const button = e.target;
                    const itemId = button.dataset.itemId;
                    if (confirm(`确定要删除这个实体吗 (ID: ${itemId})？`)) {
                        try {
                            button.disabled = true;
                            button.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                            await window.api.deleteItem(itemId);
                            await loadEntityData(currentLabelCode);
                        } catch (error) {
                            console.error('删除失败:', error);
                            alert(`删除失败: ${error.message}`);
                            button.disabled = false;
                            button.textContent = '删除';
                        }
                    }
                }
            });

            document.getElementById('add-entity-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitButton = this.querySelector('button[type="submit"]');
                const creationPromises = [];
                const entityRows = document.querySelectorAll('#entity-rows-container .entity-row');

                entityRows.forEach(row => {
                    const name = row.querySelector('.item-name-input').value.trim();
                    if (name) {
                        const itemData = {
                            item_name: name,
                            item_code: row.querySelector('.item-code-input').value.trim(),
                            item_synonym: row.querySelector('.item-synonym-input').value.trim(),
                            is_active: row.querySelector('.entity-status-switch').checked
                        };
                        creationPromises.push(window.api.addItemToLabel(currentLabelCode, itemData));
                    }
                });

                if (creationPromises.length === 0) {
                    alert('没有可提交的实体，请输入至少一个实体名称。');
                    return;
                }

                try {
                    submitButton.disabled = true;
                    submitButton.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>正在提交...`;
                    await Promise.all(creationPromises);
                    closeAddEntityModal();
                    await loadEntityData(currentLabelCode);
                } catch (error) {
                    console.error('新增实体失败:', error);
                    alert(`新增实体失败: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '确定新增';
                }
            });

            document.getElementById('add-entity-button').addEventListener('click', openAddEntityModal);
            document.getElementById('master-status-switch').addEventListener('change', function(e) {
                document.querySelectorAll('.entity-status-switch').forEach(sw => { sw.checked = e.target.checked; });
            });

            // --- Add Tag Modal Logic ---
            let parentLabelChoices = null;

            async function openAddTagModal() {
                const modal = document.getElementById('add-tag-modal');
                const select = document.getElementById('parent-label-code');
                modal.classList.remove('hidden');

                if (parentLabelChoices) {
                    parentLabelChoices.destroy();
                }
                parentLabelChoices = new Choices(select, { searchEnabled: true, itemSelectText: '按回车选中' });
                parentLabelChoices.setChoices([ { value: '', label: '无 (设为顶级标签)' } ]);

                try {
                    const response = await window.api.getLabels({ size: 1000 });
                    const choices = response.data.items.map(label => ({ value: label.label_code, label: `${label.label_name} (${label.label_code})` }));
                    // Prepend the initial empty choice
                    choices.unshift({ value: '', label: '无 (设为顶级标签)' });
                    parentLabelChoices.setChoices(choices, 'value', 'label', true);
                    // Set current tag as default parent if it exists
                    if(currentLabelCode) {
                        parentLabelChoices.setValue(currentLabelCode);
                    }
                } catch (error) {
                    console.error("Failed to load parent labels", error);
                }
            }

            function closeAddTagModal() {
                document.getElementById('add-tag-modal').classList.add('hidden');
            }

            document.getElementById('add-tag-button').addEventListener('click', openAddTagModal);
            document.getElementById('cancel-add-tag').addEventListener('click', closeAddTagModal);

            document.getElementById('add-tag-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitButton = this.querySelector('button[type="submit"]');
                const formData = new FormData(this);
                const labelData = Object.fromEntries(formData.entries());
                
                // A real implementation would fetch parent and set level = parent.level + 1
                labelData.level = labelData.parent_label_code ? 2 : 1; // Simplified level calculation

                try {
                    submitButton.disabled = true; submitButton.innerHTML = `<i class="fa fa-spinner fa-spin"></i>`;
                    await window.api.createLabel(labelData);
                    closeAddTagModal();
                    await initializeApp(); // Re-render the whole tree
                } catch (error) {
                    alert(`新增标签失败: ${error.message}`);
                } finally {
                    submitButton.disabled = false; submitButton.textContent = '确定新增';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>